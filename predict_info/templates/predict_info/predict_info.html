{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주가 예측 서비스</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <link rel="stylesheet" href="{% static 'css/style.css' %}"> {# 메인 스타일 있다면 유지 #}
    {# <link rel="stylesheet" href="{% static 'css/invest.css' %}"> #}
    {# <link rel="stylesheet" href="{% static 'css/community.css' %}"> #}

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f2f5; /* 약간 부드러운 배경색 */
            padding-top: 70px; /* 헤더 높이만큼 패딩 */
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .prediction-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1.5rem;
        }

        .prediction-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .prediction-card h3 {
            color: #333;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-control-lg {
            border-radius: 8px;
            box-shadow: none;
        }
        .form-control-lg:focus {
            border-color: #0d6efd; /* Bootstrap primary color */
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .btn-custom-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
            border-radius: 8px;
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-custom-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        .btn-custom-success {
            background-color: #198754; /* Bootstrap success color */
            border-color: #198754;
            border_radius: 8px;
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-custom-success:hover {
            background-color: #157347;
            border-color: #146c43;
        }


        #autocompleteResults {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 1050; /* 헤더보다 높게 */
            background-color: white; border: 1px solid #dee2e6; border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px; overflow-y: auto; display: none;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        #autocompleteResults .list-group-item {
            padding: 0.75rem 1rem; font-size: 0.95rem; cursor: pointer;
            border: none; /* 내부 아이템 테두리 제거 */
            border-bottom: 1px solid #f0f0f0; /* 구분선 */
        }
        #autocompleteResults .list-group-item:last-child {
            border-bottom: none;
        }
        #autocompleteResults .list-group-item:hover {
            background-color: #e9ecef;
        }
        #autocompleteResults .stock-name { font-weight: 500; }
        #autocompleteResults .stock-code-market { font-size: 0.85em; color: #6c757d; }


        .prediction-result-area {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .prediction-result-area h4 {
            font-weight: 500; color: #212529; margin-bottom: 1rem;
        }
        .data-placeholder { color: #6c757d; font-style: italic; text-align: center; padding: 2rem 0; }
        .error-message { color: #dc3545; font-weight: 500; text-align: center; padding: 1rem; background-color: #f8d7da; border-color: #f5c2c7; border-radius: 8px;}
        .loading-indicator { text-align: center; padding: 2rem 0; }
        .loading-indicator .spinner-border { width: 3rem; height: 3rem; }

        .prediction-table { margin-top: 1rem; }
        .prediction-table th { background-color: #6c757d; color: white; font-weight: 500; }
        .prediction-table td { vertical-align: middle; }

        #predictionChartContainer {
            width: 100%;
            margin: 1.5rem auto 0 auto;
            padding: 1rem;
            border-radius: 8px;
            background-color: #fff;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        canvas#predictionChart {
             max-height: 400px; /* 차트 최대 높이 제한 */
        }
        
        .footer {
            background-color: #343a40;
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }
        .footer a { color: #0dcaf0; }

    </style>
</head>
<body data-is-authenticated="{{ request.user.is_authenticated|yesno:'true,false' }}"
      data-login-url="{% url 'account:login' %}"
      data-logout-url="{% url 'account:logout' %}"
      data-user-nickname="{{ request.user.nickname|default:'사용자'|escapejs }}">

    {% include 'main_header.html' %} {# main_header.html이 Bootstrap 5와 호환되는지 확인 필요 #}

    <div class="container prediction-container">
        <div class="prediction-card">
            <h3><i class="bi bi-graph-up-arrow me-2"></i>종목별 주가 예측</h3>
            <form id="stockPredictionForm" class="mb-4">
                {% csrf_token %}
                <div class="input-group mb-3 position-relative">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="stockQueryInput" name="stock_query" value="{{ stock_name_for_display }}" placeholder="종목명 또는 6자리 코드를 입력하세요 (예: 삼성전자 또는 005930)" class="form-control form-control-lg" autocomplete="off">
                    <div id="autocompleteResults" class="list-group"></div>
                </div>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                    <button type="button" id="technicalPredictButton" class="btn btn-custom-primary btn-lg predict-ajax-btn" data-analysis-type="technical">
                        <i class="bi bi-bar-chart-line-fill me-2"></i>기술적 분석 예측
                    </button>
                 
                    <button type="button" id="comprehensivePredictButton" class="btn btn-custom-success btn-lg predict-ajax-btn" data-analysis-type="comprehensive">
                        <i class="bi bi-clipboard-data-fill me-2"></i>종합 분석 예측
                    </button>
                </div>
            </form>

            <div id="predictionDisplayArea" class="prediction-result-area">
                {% if error_message %}
                    <div class="alert alert-warning error-message">{{ error_message }}</div>
                {% endif %}

                <h4 class="text-center">
                    <span id="predictedStockName">{% if stock_name_for_display %}{{ stock_name_for_display }}{% else %}종목 검색 후 예측 버튼을 클릭하세요{% endif %}</span>
                    <span id="predictedStockCode" class="text-muted">{% if ticker %}({{ ticker }}){% endif %}</span>
                    - <span id="predictionTypeDisplay" class="fw-bold"></span> 5 영업일 예측
                </h4>

                <div id="ajaxLoadingIndicator" class="loading-indicator" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">예측 데이터를 불러오는 중입니다...</p>
                </div>

                <div id="predictionResultData">
                    {% if not error_message %}
                    <p class="data-placeholder">
                        <i class="bi bi-info-circle me-1"></i> 위에서 종목을 검색하고 분석 유형 버튼을 클릭하면 예측 결과를 볼 수 있습니다.
                    </p>
                    {% endif %}
                </div>
                 <div id="predictionChartContainer" style="display: none;">
                    <canvas id="predictionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    {% include 'main_footer.html' %} {# main_footer.html이 Bootstrap 5와 호환되는지 확인 필요 #}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/script.js' %}"></script> {# 공통 script.js가 있다면 유지 #}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const predictButtons = document.querySelectorAll('.predict-ajax-btn');
            const stockQueryInput = document.getElementById('stockQueryInput');
            const resultDiv = document.getElementById('predictionResultData');
            const loadingDiv = document.getElementById('ajaxLoadingIndicator');
            const csrfTokenInput = document.querySelector('#stockPredictionForm [name=csrfmiddlewaretoken]');
            
            const predictedStockNameSpan = document.getElementById('predictedStockName');
            const predictedStockCodeSpan = document.getElementById('predictedStockCode');
            const predictionTypeDisplaySpan = document.getElementById('predictionTypeDisplay');
            
            const chartContainer = document.getElementById('predictionChartContainer');
            const chartCanvas = document.getElementById('predictionChart');
            let predictionChartInstance = null;

            const autocompleteResultsDiv = document.getElementById('autocompleteResults');
            let autocompleteRequestTimeout;

            // 초기 화면에서 예측 결과 영역 제목 기본값 설정
            if (!predictedStockNameSpan.textContent.includes('검색 후')) {
                 predictionTypeDisplaySpan.textContent = "기술적 분석"; // 기본값
            }


            if (stockQueryInput && autocompleteResultsDiv) {
                stockQueryInput.addEventListener('input', function() {
                    const query = this.value.trim();
                    clearTimeout(autocompleteRequestTimeout);

                    if (query.length < 1) { // 최소 1글자 이상 입력 시 검색
                        autocompleteResultsDiv.innerHTML = '';
                        autocompleteResultsDiv.style.display = 'none';
                        return;
                    }
                    autocompleteRequestTimeout = setTimeout(() => {
                        fetch(`{% url 'predict_info:search_stocks_ajax' %}?term=${encodeURIComponent(query)}&limit=7`)
                            .then(response => {
                                if (!response.ok) { throw new Error('Network response was not ok.'); }
                                return response.json();
                            })
                            .then(data => {
                                autocompleteResultsDiv.innerHTML = '';
                                if (data.error) {
                                    autocompleteResultsDiv.innerHTML = `<div class="list-group-item text-danger small p-2">${data.error}</div>`;
                                } else if (data.length > 0) {
                                    data.forEach(item => {
                                        const div = document.createElement('a');
                                        div.href = '#'; 
                                        div.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'justify-content-between', 'align-items-center');
                                        div.innerHTML = `<span class="stock-name">${item.value}</span> <small class="stock-code-market">${item.code} | ${item.market}</small>`;
                                        div.addEventListener('click', function(e) {
                                            e.preventDefault();
                                            stockQueryInput.value = item.value; // 종목명으로 채우기
                                            autocompleteResultsDiv.style.display = 'none';
                                            // 선택 시 바로 기술적 분석 실행 (선택사항)
                                            // document.getElementById('technicalPredictButton').click();
                                        });
                                        autocompleteResultsDiv.appendChild(div);
                                    });
                                } else {
                                    autocompleteResultsDiv.innerHTML = '<div class="list-group-item text-muted small p-2">검색 결과가 없습니다.</div>';
                                }
                                autocompleteResultsDiv.style.display = 'block';
                            })
                            .catch(error => {
                                console.error('Predict Autocomplete error:', error);
                                autocompleteResultsDiv.innerHTML = '<div class="list-group-item text-danger small p-2">검색 중 오류 발생</div>';
                                autocompleteResultsDiv.style.display = 'block';
                            });
                    }, 250); // 디바운스 시간 줄임
                });

                // 다른 곳 클릭 시 자동완성 숨기기
                document.addEventListener('click', function(event) {
                    if (!stockQueryInput.contains(event.target) && !autocompleteResultsDiv.contains(event.target)) {
                        autocompleteResultsDiv.style.display = 'none';
                    }
                });
            }

            predictButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    if (autocompleteResultsDiv) autocompleteResultsDiv.style.display = 'none';

                    const stockInputToPredict = stockQueryInput.value.trim(); // input 값 사용
                    const analysisType = this.dataset.analysisType;
                    const analysisTypeText = this.textContent.trim().replace(/<i[^>]*><\/i>|\s+/g, ' ').replace(' 예측', '').trim();


                    if (!csrfTokenInput) {
                        resultDiv.innerHTML = `<p class="error-message mt-3">오류: CSRF 토큰이 없습니다. 페이지를 새로고침해주세요.</p>`;
                        return;
                    }
                    const csrfToken = csrfTokenInput.value;

                    if (!stockInputToPredict) {
                        resultDiv.innerHTML = `<p class="error-message mt-3">종목명 또는 코드를 입력해주세요.</p>`;
                        return;
                    }

                    // 이전 결과 초기화
                    resultDiv.innerHTML = '<p class="data-placeholder"><i class="bi bi-info-circle me-1"></i>예측 결과를 기다리고 있습니다...</p>';
                    if (predictionChartInstance) {
                        predictionChartInstance.destroy();
                        predictionChartInstance = null;
                    }
                    chartContainer.style.display = 'none';
                    loadingDiv.style.display = 'block'; // 로딩 인디케이터 표시
                    
                    predictedStockNameSpan.textContent = "처리 중..."; // 예측 시작 시 "처리 중"으로 변경
                    predictedStockCodeSpan.textContent = "";
                    predictionTypeDisplaySpan.textContent = analysisTypeText;


                    fetch("{% url 'predict_info:predict_stock_price_ajax' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: new URLSearchParams({
                            'stock_input': stockInputToPredict, // 사용자가 입력한 값 전달
                            'analysis_type': analysisType
                        })
                    })
                    .then(response => {
                        if (!response.ok) { // HTTP 상태 코드가 200-299 범위가 아닐 때
                            return response.json().then(errData => {
                                // 서버에서 보낸 JSON 오류 메시지가 있다면 사용, 없다면 일반 HTTP 오류 메시지
                                throw new Error(errData.error || `서버 응답 오류: ${response.status} ${response.statusText}`);
                            }).catch(() => { // JSON 파싱 실패 시 (서버가 JSON 오류를 안 보낸 경우)
                                throw new Error(`서버 응답 오류: ${response.status} ${response.statusText}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        loadingDiv.style.display = 'none';
                        if (data.error) {
                            resultDiv.innerHTML = `<p class="error-message mt-3">${data.error}</p>`;
                            predictedStockNameSpan.textContent = stockInputToPredict; // 오류 시에도 입력값 유지
                        } else if (data.predictions && data.predictions.length > 0) {
                            predictedStockNameSpan.textContent = data.stock_name || stockInputToPredict;
                            predictedStockCodeSpan.textContent = data.stock_code ? `(${data.stock_code})` : "";
                            predictionTypeDisplaySpan.textContent = analysisTypeText;

                            let tableHtml = `
                                <p class="small text-muted mb-2 text-end">
                                    최근 데이터 기준일: ${data.last_data_date || 'N/A'}
                                    ${data.model_log_trained ? '<br><i class=\"bi bi-info-circle-fill text-primary\"></i> 이 모델은 로그 변환된 데이터로 학습되었습니다.' : ''}
                                </p>
                                <div class="table-responsive">
                                <table class="table table-hover table-sm prediction-table align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col" class="text-center">예측일</th>
                                        <th scope="col" class="text-end">예측 종가 (원)</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                            
                            const labels = [];
                            const prices = [];
                            data.predictions.forEach(pred => {
                                tableHtml += `<tr>
                                                <td class="text-center">${pred.date}</td>
                                                <td class="text-end">${Number(pred.price).toLocaleString()}</td>
                                              </tr>`;
                                labels.push(pred.date);
                                prices.push(pred.price);
                            });
                            tableHtml += '</tbody></table></div>';
                            resultDiv.innerHTML = tableHtml;

                            // 차트 생성/업데이트
                            chartContainer.style.display = 'block';
                            const ctx = chartCanvas.getContext('2d');
                            if (predictionChartInstance) {
                                predictionChartInstance.destroy(); // 기존 차트 파괴
                            }
                            predictionChartInstance = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: `${data.stock_name || stockInputToPredict} 5영업일 예측 종가`,
                                        data: prices,
                                        borderColor: '#0d6efd',
                                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                        fill: true,
                                        tension: 0.2, // 곡선 부드러움
                                        pointBackgroundColor: '#0d6efd',
                                        pointBorderColor: '#ffffff',
                                        pointHoverBackgroundColor: '#ffffff',
                                        pointHoverBorderColor: '#0d6efd',
                                        pointRadius: 4,
                                        pointHoverRadius: 7
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false, // 컨테이너 크기에 맞춤
                                    scales: {
                                        y: {
                                            beginAtZero: false, // Y축 0부터 시작 안 함
                                            ticks: {
                                                callback: function(value) { return value.toLocaleString() + ' 원'; },
                                                font: { size: 10 }
                                            }
                                        },
                                        x: { ticks: { font: { size: 10 } } }
                                    },
                                    plugins: {
                                        legend: { display: true, labels: { font: { size: 12 } } },
                                        tooltip: {
                                            enabled: true,
                                            mode: 'index',
                                            intersect: false,
                                            backgroundColor: 'rgba(0,0,0,0.8)',
                                            titleFont: { weight: 'bold', size: 14 },
                                            bodyFont: { size: 12 },
                                            padding: 10,
                                            callbacks: {
                                                label: function(context) {
                                                    let label = context.dataset.label || '';
                                                    if (label) { label += ': '; }
                                                    if (context.parsed.y !== null) {
                                                        label += context.parsed.y.toLocaleString() + ' 원';
                                                    }
                                                    return label;
                                                }
                                            }
                                        }
                                    },
                                    hover: { mode: 'nearest', intersect: true }
                                }
                            });
                        } else { // 예측 결과는 성공적으로 받았으나, predictions 배열이 비어있는 경우
                            resultDiv.innerHTML = '<p class="text-center mt-3">예측 결과를 생성할 수 없습니다. 입력값을 확인하거나 잠시 후 다시 시도해주세요.</p>';
                            predictedStockNameSpan.textContent = stockInputToPredict;
                        }
                    })
                    .catch(error => {
                        loadingDiv.style.display = 'none';
                        resultDiv.innerHTML = `<p class="error-message mt-3">오류 발생: ${error.message}</p>`;
                        predictedStockNameSpan.textContent = stockInputToPredict; // 오류 시에도 입력값 유지
                        console.error("Prediction Fetch Error:", error);
                    });
                });
            });

            // 페이지 로드 시 URL 파라미터에 stock_query가 있으면 해당 종목으로 자동 예측 실행
            const urlParams = new URLSearchParams(window.location.search);
            const initialStockQueryFromUrl = urlParams.get('stock_query');
            if (initialStockQueryFromUrl && initialStockQueryFromUrl.trim() !== "") {
                stockQueryInput.value = initialStockQueryFromUrl.trim();
                // 기본적으로 기술적 분석 버튼 클릭
                document.getElementById('technicalPredictButton').click();
            }

        });
    </script>
</body>
</html>

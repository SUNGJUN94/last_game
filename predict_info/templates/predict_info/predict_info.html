{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>예측정보</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/invest.css' %}">
    <link rel="stylesheet" href="{% static 'css/community.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .prediction-section { margin-top: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; }
        .prediction-section h3, .prediction-section h6 { margin-bottom: 15px; font-weight: bold; }
        .error-message { color: red; font-weight: bold; }
        .loading-indicator { text-align: center; padding: 10px; }
        .prediction-table th { background-color: #007bff; color: white; }
        .data-placeholder { color: #6c757d; font-style: italic; text-align: center; }
        .market-index-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
        }
        .market-index-box .market-name {
            font-size: 1.25rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: .5rem;
        }
        .market-index-box .index-details span {
            display: block;
            margin-bottom: .25rem;
        }
        .market-index-box .index-details .price {
            font-weight: bold;
        }
        .market-index-box .index-details .change-positive { color: #dc3545; }
        .market-index-box .index-details .change-negative { color: #007bff; }
        .market-index-box .index-details .change-neutral { color: #6c757d; }
        #predictionChartContainer {
            width: 100%;
            max-width: 700px;
            margin: 20px auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
        }

        /* 자동완성 스타일 */
        #autocompleteResults {
            position: absolute;
            z-index: 1000;
            background-color: white;
            border: 1px solid #ced4da;
            border-top: none;
            max-height: 250px; /* 최대 높이 */
            overflow-y: auto; /* 스크롤 */
            width: 100%; /* 부모 요소 너비에 맞춤 */
            display: none; /* 기본 숨김 */
        }
        #stockPredictionForm .input-group {
            position: relative; /* 자동완성 div의 기준점 */
        }
        #autocompleteResults .list-group-item {
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            cursor: pointer;
        }
        #autocompleteResults .list-group-item:hover {
            background-color: #f0f0f0;
        }

        /* 모바일 버튼 레이아웃 수정 */
        @media (max-width: 575.98px) { /* Bootstrap xs breakpoint */
            .predict-ajax-btn {
                font-size: 0.8rem; /* 폰트 크기 줄이기 */
                padding: 0.3rem 0.6rem; /* 패딩 줄이기 */
                /* 필요하다면 flex-grow: 1; 추가해서 버튼들이 공간을 균등하게 차지하도록 설정 */
            }
            #stockPredictionForm .d-flex { /* 버튼 그룹 */
                flex-direction: row !important; /* 항상 가로 방향 */
                /* justify-content: space-around; */ /* 버튼 간 간격 조정 옵션 */
            }
        }
    </style>
</head>
<body
data-is-authenticated="{{ request.user.is_authenticated|yesno:'true,false' }}"
  data-login-url="{% url 'account:login' %}"
  data-logout-url="{% url 'account:logout' %}"
  data-user-nickname="{{ request.user.nickname|default:'사용자'|escapejs }}"
>
    {% include 'main_header.html' %}

    <div id="app" style="padding-top: 60px;">
        <div class="container my-3 prediction-section">
            <h3>종목별 5 영업일 종가 예측</h3>
            <form id="stockPredictionForm" class="mb-3"> {% csrf_token %}
                <div class="input-group mb-1"> 
                    <input type="text" id="stockQueryInput" name="stock_query" value="" placeholder="종목명 또는 코드를 입력하세요." class="form-control" autocomplete="off">
                </div>
                <div id="autocompleteResults" class="list-group"></div>
                
                <div class="d-flex flex-wrap gap-2 justify-content-start mt-2">
                    
                    <button type="button" id="technicalPredictButton" class="btn btn-primary predict-ajax-btn" data-analysis-type="technical">기술적 분석</button> 
                    <button type="button" id="comprehensivePredictButton" class="btn btn-success predict-ajax-btn" data-analysis-type="comprehensive">종합 분석</button> 
                </div>
            </form>

            <div id="predictionDisplayArea">
                {% if error_message and not prediction_error %}
                    <div class="alert alert-danger">{{ error_message }}</div>
                {% endif %}

                <h4>
                    <span id="predictedStockName">종목을 검색하고 예측 버튼을 클릭하세요.</span>
                    (<span id="predictedStockCode"></span>)
                    - <span id="predictionTypeDisplay"></span> 5 영업일 예측 결과
                </h4>
                <div id="predictionResultData">
                    <p class="data-placeholder">위에서 종목을 검색하고 분석 유형 버튼을 클릭하면 예측 결과를 볼 수 있습니다.</p>
                </div>
            </div>
            <div id="ajaxLoadingIndicator" class="loading-indicator" style="display: none;">
                <p>예측 중입니다...</p>
            </div>
            <div id="predictionChartContainer" style="display: none;">
                <canvas id="predictionChart"></canvas>
            </div>
        </div>

        <div class="container my-3">
            <div class="row text-center">
                {% if prediction_indices %}
                    {% for index_item in prediction_indices %}
                    <div class="col-md-6 mb-3">
                        <div class="market-index-box">
                            <div class="market-name">{{ index_item.name }} ({{ index_item.date_display }})</div>
                            <div class="index-details">
                                <span class="price">
                                    전일 종가: 
                                    {% if index_item.close_price is not None %}
                                        {{ index_item.close_price|floatformat:2|intcomma }} P
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                                {% if index_item.change_percent is not None and index_item.change_value is not None %}
                                    <span>
                                        전일 대비:
                                        {% if index_item.change_percent > 0 %}
                                            <span class="change-positive">▲ {{ index_item.change_value|floatformat:2|intcomma }} (+{{ index_item.change_percent|floatformat:2 }}{{'%'}})</span>
                                        {% elif index_item.change_percent < 0 %}
                                            <span class="change-negative">▼ {{ index_item.change_value|floatformat:2|intcomma }} ({{ index_item.change_percent|floatformat:2 }}{{'%'}})</span>
                                        {% else %}
                                            <span class="change-neutral">{{ index_item.change_value|floatformat:2|intcomma }} (0.00{{'%'}})</span>
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12"><p class="data-placeholder">시장 지수 요약 정보가 없습니다.</p></div>
                {% endif %}
            </div>
        </div>

        <div class="container my-3">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6 class="fw-bold">코스피 급등 TOP 5</h6>
                    <table class="table table-sm table-bordered text-center">
                        <thead><tr><th>종목명</th><th>등락률(%)</th><th>종가</th></tr></thead>
                        <tbody>
                        {% if top5_kospi_gainers %}
                            {% for stock in top5_kospi_gainers %}
                            <tr>
                                <td>{{ stock.name }} ({{ stock.code }})</td>
                                <td style="color:{% if stock.change > 0 %}#dc3545{% elif stock.change < 0 %}#0d6efd{% else %}#6c757d{% endif %};">
                                    {% if stock.change > 0 %}+{% endif %}{{ stock.change|floatformat:2 }}{{'%'}}
                                </td>
                                <td>{{ stock.close|intcomma }}원</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="3" class="data-placeholder">데이터 없음</td></tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="fw-bold">코스닥 급등 TOP 5</h6>
                    <table class="table table-sm table-bordered text-center">
                        <thead><tr><th>종목명</th><th>등락률(%)</th><th>종가</th></tr></thead>
                        <tbody>
                        {% if top5_kosdaq_gainers %}
                            {% for stock in top5_kosdaq_gainers %}
                            <tr>
                                <td>{{ stock.name }} ({{ stock.code }})</td>
                                 <td style="color:{% if stock.change > 0 %}#dc3545{% elif stock.change < 0 %}#0d6efd{% else %}#6c757d{% endif %};">
                                    {% if stock.change > 0 %}+{% endif %}{{ stock.change|floatformat:2 }}{{'%'}}
                                </td>
                                <td>{{ stock.close|intcomma }}원</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="3" class="data-placeholder">데이터 없음</td></tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>

    {% include 'main_footer.html' %}

    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'js/script.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const predictButtons = document.querySelectorAll('.predict-ajax-btn');
            const stockQueryInput = document.getElementById('stockQueryInput');
            const resultDiv = document.getElementById('predictionResultData');
            const loadingDiv = document.getElementById('ajaxLoadingIndicator');
            const csrfTokenInput = document.querySelector('#stockPredictionForm [name=csrfmiddlewaretoken]');
            const predictedStockNameSpan = document.getElementById('predictedStockName');
            const predictedStockCodeSpan = document.getElementById('predictedStockCode');
            const predictionTypeDisplaySpan = document.getElementById('predictionTypeDisplay');
            
            const chartContainer = document.getElementById('predictionChartContainer');
            const chartCanvas = document.getElementById('predictionChart');
            let predictionChartInstance = null;

            // 자동완성 로직 추가
            const autocompleteResultsDiv = document.getElementById('autocompleteResults');
            let autocompleteRequestTimeout;

            stockQueryInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                clearTimeout(autocompleteRequestTimeout); // 이전 요청 취소 (디바운싱)

                if (query.length < 1) { // 최소 1글자 이상 입력 시
                    autocompleteResultsDiv.innerHTML = '';
                    autocompleteResultsDiv.style.display = 'none';
                    return;
                }

                autocompleteRequestTimeout = setTimeout(() => { // 300ms 디바운스
                    fetch(`{% url 'predict_info:search_stocks_ajax' %}?term=${encodeURIComponent(query)}&limit=7`)
                        .then(response => {
                            if (!response.ok) { throw new Error('Network response was not ok.'); }
                            return response.json();
                        })
                        .then(data => {
                            autocompleteResultsDiv.innerHTML = '';
                            if (data.length > 0) {
                                autocompleteResultsDiv.style.display = 'block';
                                data.forEach(item => {
                                    const div = document.createElement('a');
                                    div.href = '#'; 
                                    div.classList.add('list-group-item', 'list-group-item-action');
                                    div.textContent = item.label; // "종목명 (종목코드)"
                                    div.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        stockQueryInput.value = item.value; // input에 종목명 채우기
                                        // predictedStockNameSpan.textContent = item.value; // 선택 시 바로 반영 (선택사항)
                                        // predictedStockCodeSpan.textContent = item.code; // 선택 시 바로 반영 (선택사항)
                                        autocompleteResultsDiv.innerHTML = '';
                                        autocompleteResultsDiv.style.display = 'none';
                                        // 필요시, 선택 후 바로 예측 실행 로직 추가 가능
                                    });
                                    autocompleteResultsDiv.appendChild(div);
                                });
                            } else {
                                autocompleteResultsDiv.style.display = 'none';
                            }
                        })
                        .catch(error => {
                            console.error('Autocomplete error:', error);
                            autocompleteResultsDiv.innerHTML = '<div class="list-group-item text-danger">검색 중 오류 발생</div>';
                            autocompleteResultsDiv.style.display = 'block';
                        });
                }, 300); // 300ms 후에 요청
            });

            // 검색창 외부 클릭 시 자동완성 목록 숨기기
            document.addEventListener('click', function(event) {
                if (!stockQueryInput.contains(event.target) && !autocompleteResultsDiv.contains(event.target)) {
                    autocompleteResultsDiv.innerHTML = '';
                    autocompleteResultsDiv.style.display = 'none';
                }
            });


            predictButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    autocompleteResultsDiv.style.display = 'none'; // 예측 버튼 클릭 시 자동완성 숨김

                    const stockCodeToPredict = stockQueryInput.value.trim();
                    const analysisType = this.dataset.analysisType;
                    const analysisTypeText = this.textContent.includes('기술적') ? '기술적 분석' : '종합 분석';

                    if (!csrfTokenInput) {
                        console.error("CSRF 토큰을 찾을 수 없습니다.");
                        resultDiv.innerHTML = `<p class="error-message">오류: CSRF 토큰이 없습니다.</p>`;
                        return;
                    }
                    const csrfToken = csrfTokenInput.value;

                    if (!stockCodeToPredict) {
                        resultDiv.innerHTML = `<p class="error-message">종목명 또는 코드를 입력해주세요.</p>`;
                        return;
                    }

                    resultDiv.innerHTML = '';
                    if (predictionChartInstance) {
                        predictionChartInstance.destroy();
                        predictionChartInstance = null;
                    }
                    chartContainer.style.display = 'none';
                    loadingDiv.style.display = 'block';
                    
                    predictedStockNameSpan.textContent = "로딩 중...";
                    predictedStockCodeSpan.textContent = "";
                    predictionTypeDisplaySpan.textContent = analysisTypeText;

                    fetch("{% url 'predict_info:predict_stock_price_ajax' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: new URLSearchParams({
                            'stock_input': stockCodeToPredict,
                            'analysis_type': analysisType
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errData => { throw new Error(errData.error || `서버 오류: ${response.status}`); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        loadingDiv.style.display = 'none';
                        if (data.error) {
                            resultDiv.innerHTML = `<p class="error-message">오류: ${data.error}</p>`;
                            predictedStockNameSpan.textContent = stockCodeToPredict;
                            predictedStockCodeSpan.textContent = "";
                        } else if (data.predictions && data.predictions.length > 0) {
                            predictedStockNameSpan.textContent = data.stock_name || stockCodeToPredict;
                            predictedStockCodeSpan.textContent = data.stock_code || "";
                            predictionTypeDisplaySpan.textContent = analysisTypeText;

                            let tableHtml = '<table class="table table-sm table-striped table-hover prediction-table"><thead><tr><th>예측일</th><th>예측 종가</th></tr></thead><tbody>';
                            const labels = [];
                            const prices = [];
                            data.predictions.forEach(pred => {
                                tableHtml += `<tr><td>${pred.date}</td><td>${Number(pred.price).toLocaleString()} 원</td></tr>`;
                                labels.push(pred.date);
                                prices.push(pred.price);
                            });
                            tableHtml += '</tbody></table>';
                            resultDiv.innerHTML = tableHtml;

                            chartContainer.style.display = 'block';
                            const ctx = chartCanvas.getContext('2d');
                            predictionChartInstance = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: `${data.stock_name || stockCodeToPredict} 5영업일 예측 종가`,
                                        data: prices,
                                        borderColor: 'rgb(75, 192, 192)',
                                        tension: 0.1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: false,
                                            ticks: {
                                                callback: function(value, index, values) {
                                                    return value.toLocaleString() + ' 원';
                                                }
                                            }
                                        }
                                    },
                                    plugins: {
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    let label = context.dataset.label || '';
                                                    if (label) {
                                                        label += ': ';
                                                    }
                                                    if (context.parsed.y !== null) {
                                                        label += context.parsed.y.toLocaleString() + ' 원';
                                                    }
                                                    return label;
                                                }
                                            }
                                        }
                                    }
                                }
                            });

                        } else {
                            resultDiv.innerHTML = '<p>예측 결과를 받지 못했습니다.</p>';
                            predictedStockNameSpan.textContent = stockCodeToPredict;
                            predictedStockCodeSpan.textContent = "";
                        }
                    })
                    .catch(error => {
                        loadingDiv.style.display = 'none';
                        console.error('Error:', error);
                        resultDiv.innerHTML = `<p class="error-message">예측 중 오류 발생: ${error.message}</p>`;
                        predictedStockNameSpan.textContent = stockCodeToPredict;
                        predictedStockCodeSpan.textContent = "";
                    });
                });
            });
        });
    </script>
</body>
</html>